---
title: "SYD Covid-19 cases EDA"
author: "Tony Liu"
date: "`r Sys.Date()`"
output:
  html_notebook:
    code_folding: hide
    highlight: zenburn
    theme: flatly
    toc: yes
    toc_float:
      collapsed: no
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
# source("utility.R")
source("R_functions.R")
source("R_data_prepocessing.R")

options(scipen=999, expressions=50000, 
        DT.options = list(pageLength = 8,
                          scrollX = TRUE,
                          dom = 'Bfrtip',
                          buttons = c('copy', 'csv', 'excel', 'pdf', 'print'), 
                          autoWidth = TRUE)) 

knitr::opts_chunk$set(echo = T, message=F, warning=F, fig.width=9.5, fig.height=4)
knitr::opts_knit$set(dev.args = list(type = "cairo"), progress=FALSE)
```

# News headline {.tabset}
## 1st half 2020

```{r, fig.width=10, fig.height=12}
AU_timeline %>% 
  filter(date <= ymd(20200515)) %>%
  arrange(date) %>% 
  # filter(nchar(event) < 230) %>% 
  # filter(region != "VIC") %>% 
  mutate(rowid = as.numeric(rownames(.))) %>% 
  mutate(date_gap = as.numeric(date-lag(date))) %>% 
  mutate(nchar = nchar(event), 
         nchar_scaled = (nchar-min(nchar))/(max(nchar)-min(nchar)), 
         # point_position = 700 * nchar_scaled * (-1)^rowid,
         point_position = c(100,100,280,320,550,20,100,550,720,150,
                            240,880,400,300)*(-1)^rowid
         ) %>% 
  mutate(facet_var = quarter(date, with_year = T)) %>% 
  
  ggplot(aes(x=date, y=0)) + 
  geom_line() + 
  geom_point(aes(col=region)) +
  geom_segment(aes(x=date, xend=date, col=region,
                   y=0, yend=point_position)) +
  geom_point(aes(y=point_position, col=region), shape=1) +
  geom_text(aes(y=-10, 
                label=paste0(day(date), " ", 
                             month(date, label=T))), 
            angle=30, 
            vjust=1, hjust=1) + 
  geom_label(aes(label=str_wrap(paste0(date, ": ", event), nchar/1.8), alpha=.7,
                 # directions="y", min.segment.length = Inf,
                 x=date, y=point_position, col=region, vjust="outward")) +
  scale_x_date(date_breaks = "1 month", 
               date_labels = "%b %Y") + 
  # facet_wrap(~facet_var, strip.position="top",
  #            ncol = 1, scales = "free_x") +
  # coord_flip() +
  ylim(-1200,1200) + 
  coord_cartesian(clip = "off") + 
  labs(subtitle = "AU/NSW Covid-19 timeline, 1st half 2020") +
  theme_void(base_size = 23) +
  theme(legend.position = "none", 
        # rect = element_rect(fill = "transparent"),
        plot.margin = unit(c(0, 2.3, 0, 2.3),"cm"),
        # plot.background = element_rect(fill = NULL)
        )
```

## 2nd half 2020

```{r, fig.width=10, fig.height=12}
AU_timeline %>% 
  filter(date > ymd(20200515)) %>%
  arrange(date) %>% 
  # filter(nchar(event) < 230) %>% 
  # filter(region != "VIC") %>% 
  mutate(rowid = as.numeric(rownames(.))) %>% 
  mutate(date_gap = as.numeric(date-lag(date))) %>% 
  mutate(nchar = nchar(event), 
         nchar_scaled = (nchar-min(nchar))/(max(nchar)-min(nchar)), 
         # point_position = 700 * nchar_scaled * (-1)^rowid,
         point_position = c(50,100,280,420,550,720,100,550,720,150,
                            240,780,830,300)*(-1)^rowid
         ) %>% 
  mutate(facet_var = quarter(date, with_year = T)) %>% 
  
  ggplot(aes(x=date, y=0)) + 
  geom_line() + 
  geom_point(aes(col=region)) +
  geom_segment(aes(x=date, xend=date, col=region,
                   y=0, yend=point_position)) +
  geom_point(aes(y=point_position, col=region), shape=1) +
  geom_text(aes(y=-10, 
                label=paste0(day(date), " ", 
                             month(date, label=T))), 
            angle=30, 
            vjust=1, hjust=1) + 
  geom_label(aes(label=str_wrap(paste0(date, ": ", event), nchar/3), alpha=.7,
                 # directions="y", min.segment.length = Inf,
                 x=date, y=point_position, col=region, vjust="outward")) +
  scale_x_date(date_breaks = "1 month", 
               date_labels = "%b %Y") + 
  # facet_wrap(~facet_var, strip.position="top",
  #            ncol = 1, scales = "free_x") +
  # coord_flip() +
  ylim(-1200,1200) + 
  coord_cartesian(clip = "off") + 
  labs(subtitle = "AU/NSW Covid-19 timeline, 2nd half 2020") +
  theme_void(base_size = 23) +
  theme(legend.position = "none", 
        # rect = element_rect(fill = "transparent"),
        plot.margin = unit(c(0, 2.3, 0, 2.3),"cm"),
        # plot.background = element_rect(fill = NULL)
        )
```

## Full

```{r, fig.width=10, fig.height=25}
AU_timeline %>% 
  # filter(date >= ymd(20200220)) %>% 
  arrange(date) %>% 
  add_row(date = ymd(20200120), event="") %>%
  # add_row(date = ymd(20200220), event="") %>%
  add_row(date = ymd(20200331), event="") %>%
  add_row(date = ymd(20200401), event="") %>%
  add_row(date = ymd(20200630), event="") %>%
  add_row(date = ymd(20200701), event="") %>%
  add_row(date = ymd(20200930), event="") %>%
  add_row(date = ymd(20201001), event="") %>%
  # filter(nchar(event) < 230) %>% 
  # filter(region != "VIC") %>% 
  mutate(rowid = as.numeric(rownames(.))) %>% 
  mutate(date_gap = as.numeric(date-lag(date))) %>% 
  mutate(nchar = nchar(event), 
         nchar_scaled = (nchar-min(nchar))/(max(nchar)-min(nchar)), 
         point_position = 800 * nchar_scaled * (-1)^rowid,
         # point_position = c(100)*(-1)^rowid
         ) %>% 
  mutate(facet_var = quarter(date, with_year = T)) %>% 
  
  ggplot(aes(x=date, y=0)) + 
  geom_line() + 
  geom_point(aes(col=region)) +
  geom_segment(aes(x=date, xend=date, col=region,
                   y=0, yend=point_position)) +
  geom_point(aes(y=point_position, col=region), shape=1) +
  geom_text(aes(y=-10, 
                label=paste0(day(date), " ", 
                             month(date, label=T))), 
            angle=30, 
            vjust=1, hjust=1) + 
  geom_label(aes(label=str_wrap(paste0(date, ": ", event), nchar/2), alpha=.7,
                 # directions="y", min.segment.length = Inf,
                 x=date, y=point_position, col=region, vjust="outward")) +
  scale_x_date(date_breaks = "1 month", 
               date_labels = "%b %Y") + 
  facet_wrap(~facet_var, strip.position="top",
             ncol = 1, scales = "free_x") +
  # coord_flip() +
  ylim(-1200,1200) + 
  coord_cartesian(clip = "off") + 
  theme_void(base_size = 23) +
  theme(legend.position = "none", 
        # rect = element_rect(fill = "transparent"),
        plot.margin = unit(c(0, 2.3, 0, 2.3),"cm"),
        # plot.background = element_rect(fill = NULL)
        )
```

# Time series
## Daily

```{r, fig.width=8, fig.height=4}
confirmed_cases %>% 
  filter(as.character(postcode) %in% SYD_POA$POA_NAME16) %>% 
  count(notification_date) %>% 
  ggplot(aes(x=notification_date , y=n)) + 
  # geom_point() + 
  geom_line() + 
  ylab("Count of cases") + 
  labs(subtitle = "Daily new confirmed Covid-19 cases (SYD metro)") + 
  annotate("text", x=ymd(20200505), y=110, size=3.3, col="darkred", 
           label="1st outbreak \n (Bondi beach, \nSouth Eastern \nSydney)") + 
  annotate("text", x=ymd(20200815), y=33, size=3.3, col="darkred", 
           label="2nd outbreak \n (Westmead & Liverpool, \nWestern Sydney)") + 
  annotate("text", x=ymd(20210101), y=42, size=3.3, col="darkred", 
           label="3rd outbreak \n (Avalon beach, Northern Sydney)") + 
  ggl()
```

```{r, fig.width=8, fig.height=5}
confirmed_cases %>% 
  filter(as.character(postcode) %in% SYD_POA$POA_NAME16) %>% 
  count(lhd_2010_name, notification_date) %>% 
  ggplot(aes(x=notification_date , y=n, col=lhd_2010_name)) + 
  # geom_point() + 
  geom_line() + 
  # facet_wrap(~lhd_2010_name) + 
  labs(subtitle = "Daily new confirmed Covid-19 cases (SYD)") + 
  ggl(lp = "right")
```

## Cumulative

```{r, fig.width=8, fig.height=5}
confirmed_cases %>% 
  filter(as.character(postcode) %in% SYD_POA$POA_NAME16) %>% 
  mutate(lhd_2010_name = ifelse(lhd_2010_name == "Sydney", "Metro Sydney", 
                                lhd_2010_name)) %>% 
  # mutate(lhd_2010_name = ifelse(is.na(lhd_2010_name), "Unknown", lhd_2010_name)) %>%
  count(lhd_2010_name, notification_date) %>% 
  group_by(lhd_2010_name) %>% 
  mutate(days_since_first_case = notification_date - min(notification_date)) %>% 
  mutate(accumulated_cases = cumsum(n)) %>% 
  mutate(lab = ifelse(notification_date == max(notification_date, na.rm=T), 
                      lhd_2010_name, NA)) %>% 
  
  ggplot(aes(x=days_since_first_case , y=accumulated_cases, col=lhd_2010_name)) + 
  # geom_point() + 
  geom_line() + 
  geom_text_repel(aes(label=lab), size=4, hjust=-.1, min.segment.length = 10) + 
  # facet_wrap(~lhd_2010_name) + 
  labs(subtitle = "Accumulated confirmed Covid-19 cases (SYD), by region") + 
  xlim(c(0,550)) +
  ggl(lp = "none") 
```

```{r, fig.width=9, fig.height=6}
confirmed_cases %>% 
  mutate(lhd_2010_name = ifelse(lhd_2010_name == "Sydney", "Metro Sydney", 
                                lhd_2010_name)) %>% 
  filter(as.character(postcode) %in% SYD_POA$POA_NAME16) %>% 
  # filter(lhd_2010_name %in% c("South Eastern Sydney", 
  #                          "Northern Sydney", 
  #                          "Western Sydney", 
  #                          "South Western Sydney", 
  #                          "Sydney") | is.na(lhd_2010_name)) %>% 
  count(lhd_2010_name, postcode, notification_date) %>% 
  group_by(lhd_2010_name, postcode) %>% 
  mutate(days_since_first_case = notification_date - min(notification_date)) %>% 
  mutate(accumulated_cases = cumsum(n)) %>% 
  mutate(lab=ifelse(notification_date == max(notification_date), postcode, NA)) %>% 
  
  ggplot(aes(x=days_since_first_case , y=accumulated_cases, 
             group=postcode,
             col=lhd_2010_name)) + 
  # geom_point() + 
  geom_line() + 
  geom_text(aes(label=lab), size=3, hjust="outward") + 
  facet_wrap(~lhd_2010_name) +
  labs(subtitle = "Accumulated confirmed Covid-19 cases (Sydney), by postcode") + 
  xlim(c(0,550)) +
  ggl(lp = "none", ) + 
  theme(strip.text.x = element_text(size = 12))
```

# Map

Looks like each postcode (POA) can only belong to one LGA, which is not the case for SA2

```{r}
confirmed_cases %>% 
  distinct(postcode, lga_name19) %>% 
  count(postcode) %>% 
  summarise(max(n)) %>% 
  pull()
```


## LGA

```{r, fig.width=10, fig.height=7}
confirmed_cases %>% 
  filter(lga_name19 %in% SYD_LGA$LGA_NAME19) %>% 
  count(lga_name19, name="Total_cases") %>% 
  rename(LGA_NAME19 = lga_name19) %>% 
  mutate(LGA_NAME19 = fct_reorder(LGA_NAME19, Total_cases)) %>% 
  plot_map_TL(SYD_LGA, "LGA_NAME19", "Total_cases", 
           "Total Covid-19 cases by LGA (SYD Metro)", show_count = T)
```

## POA

```{r, fig.width=9.5, fig.height=7}
confirmed_cases %>% 
  filter(as.character(postcode) %in% SYD_POA$POA_NAME16) %>% 
  count(postcode, name="Total_cases") %>% 
  rename(POA_NAME16 = postcode) %>% 
  mutate(POA_NAME16 = fct_reorder(as.factor(POA_NAME16), Total_cases)) %>% 
  plot_map_TL(SYD_POA, "POA_NAME16", "Total_cases", 
           "Total Covid-19 cases by POA (SYD Metro)", 
           show_count = T, label_size = 2)
```

```{r, fig.width=9.5, fig.height=7}
confirmed_cases %>%
  filter(as.character(postcode) %in% SYD_POA$POA_NAME16) %>%
  count(postcode, name="Total_cases") %>%
  rename(POA_NAME16 = postcode) %>%
  mutate(POA_NAME16 = fct_reorder(as.factor(POA_NAME16), Total_cases)) %>%
  mutate(cluster_origin = ifelse(POA_NAME16 %in% c("2026", "2145", "2107", "2170"),
                                 "cluster_origin", "") %>% as.factor) %>%
  plot_map_factor_TL(SYD_POA, "POA_NAME16", "Total_cases", "cluster_origin",
              "Total Covid-19 cases by POA (SYD Metro), highlighted by cluster origin",
              show_count = T, label_size = 2)
```

```{r, fig.width=9.5, fig.height=7}
confirmed_cases %>% 
  filter(!(postcode %in% c(2026, 2145, 2170))) %>% 
  filter(as.character(postcode) %in% SYD_POA$POA_NAME16) %>% 
  count(postcode, name="Total_cases") %>% 
  rename(POA_NAME16 = postcode) %>% 
  mutate(POA_NAME16 = fct_reorder(as.factor(POA_NAME16), Total_cases)) %>% 
  plot_map_TL(SYD_POA, "POA_NAME16", "Total_cases", 
           "Total Covid-19 cases by POA (SYD Metro), excluding top 3 POA", 
           show_count = T, label_size = 2)
```

## Note

Northern Beaches has many postcodes which result in more diluted choropleth by POA.

```{r, fig.width=8, fig.height=6}
confirmed_cases %>% 
  distinct(lga_name19, postcode) %>% 
  count(lga_name19, name="Number_of_postcodes") %>% 
  left_join(confirmed_cases %>% count(lga_name19, name="Total_cases"), 
            by="lga_name19") %>% 
  slice_max(n=30, order_by = Total_cases) %>% 
  gather(key, value, -lga_name19) %>% 
  ggplot(aes(x=reorder(lga_name19, value), y=value)) + 
  geom_col() + 
  facet_wrap(~key, scales = "free_x") + 
  coord_flip() + 
  xlab("") + ylab("") + 
  ggl()
```

# Map overtime cumulative
## By quarter {.tabset}
### Accumulated cases

```{r, fig.width=9.5, fig.height=7}
confirmed_cases %>% 
  filter(as.character(postcode) %in% SYD_POA$POA_NAME16) %>% 
  mutate(year_quarter = paste(year(notification_date), "Q",
                             quarter(notification_date), sep="-")) %>% 
  count(year_quarter, postcode, name="Total_cases") %>% 
  complete(year_quarter, postcode, fill = list(Total_cases=0)) %>% 
  group_by(postcode) %>% 
  mutate(Accumulated_cases = cumsum(Total_cases)) %>% 
  group_by(year_quarter) %>% 
  mutate(Accumulated_share = (Accumulated_cases/sum(Accumulated_cases, 
                                                    na.rm=T))) %>% 
  mutate(facet_var = paste0(year_quarter, 
                            "\nAccumulated: ", 
                            comma(sum(Accumulated_cases)))) %>% 
  rename(POA_NAME16 = postcode) %>% 
  
  plot_map_TL(rmapshaper::ms_simplify(
    SYD_POA[SYD_POA$POA_NAME16 %in% as.character(
      confirmed_cases$postcode) ,], .01), 
              "POA_NAME16", "Accumulated_cases", 
           "Total Covid-19 cases by POA (SYD Metro)", 
           return_obj="map") + 
  facet_wrap(~facet_var) + 
  theme(legend.position = "top")
```

### Accumulated share

```{r, fig.width=9.5, fig.height=7}
confirmed_cases %>% 
  filter(as.character(postcode) %in% SYD_POA$POA_NAME16) %>% 
  mutate(year_quarter = paste(year(notification_date), "Q",
                             quarter(notification_date), sep="-")) %>% 
  count(year_quarter, postcode, name="Total_cases") %>% 
  complete(year_quarter, postcode, fill = list(Total_cases=0)) %>% 
  group_by(postcode) %>% 
  mutate(Accumulated_cases = cumsum(Total_cases)) %>% 
  group_by(year_quarter) %>% 
  mutate(Accumulated_share = (Accumulated_cases/sum(Accumulated_cases, 
                                                    na.rm=T))) %>%
  mutate(facet_var = paste0(year_quarter, 
                            "\nAccumulated: ", 
                            comma(sum(Accumulated_cases)))) %>% 
  rename(POA_NAME16 = postcode) %>% 
  
  plot_map_TL(rmapshaper::ms_simplify(
    SYD_POA[SYD_POA$POA_NAME16 %in% as.character(
      confirmed_cases$postcode) ,], .01), 
              "POA_NAME16", "Accumulated_share", 
           "Total Covid-19 cases by POA (SYD Metro)", 
           return_obj="map") + 
  facet_wrap(~facet_var) + 
  theme(legend.position = "top")
```

## By week Mar-May 2020 {.tabset}
### Accumulated cases

```{r, fig.width=9.5, fig.height=10}
confirmed_cases %>% 
  filter(as.character(postcode) %in% SYD_POA$POA_NAME16) %>% 
  filter(year(notification_date) == 2020, 
         # month(notification_date) %in% 3:5, 
         isoweek(notification_date) %in% 10:23) %>% 
  filter(as.character(postcode) %in% SYD_POA$POA_NAME16) %>% 
  mutate(isoweek = isoweek(notification_date)) %>% 
  count(isoweek, postcode, name="Total_cases") %>% 
  complete(isoweek, postcode, fill = list(Total_cases=0)) %>% 
  group_by(postcode) %>% 
  mutate(Accumulated_cases = cumsum(Total_cases)) %>% 
  group_by(isoweek) %>% 
  mutate(Accumulated_share = (Accumulated_cases/sum(Accumulated_cases, 
                                                    na.rm=T))) %>%
  mutate(facet_var = paste0("week ", isoweek, 
                            "\nAccumulated: ", 
                            comma(sum(Accumulated_cases)))) %>% 
  rename(POA_NAME16 = postcode) %>% 
  mutate(POA_NAME16 = fct_reorder(as.factor(POA_NAME16), Total_cases)) %>% 
  ungroup() %>% 
  filter(!is.na(isoweek)) %>% 
  
  plot_map_TL(rmapshaper::ms_simplify(SYD_POA, .01), 
              "POA_NAME16", "Accumulated_cases", 
              "Total Covid-19 cases by POA (SYD Metro)", 
              return_obj="map") + 
  facet_wrap(~facet_var)
```

### Accumulated share

```{r, fig.width=9.5, fig.height=10}
confirmed_cases %>% 
  filter(as.character(postcode) %in% SYD_POA$POA_NAME16) %>% 
  filter(year(notification_date) == 2020, 
         # month(notification_date) %in% 3:5, 
         isoweek(notification_date) %in% 10:23) %>% 
  filter(as.character(postcode) %in% SYD_POA$POA_NAME16) %>% 
  mutate(isoweek = isoweek(notification_date)) %>% 
  count(isoweek, postcode, name="Total_cases") %>% 
  complete(isoweek, postcode, fill = list(Total_cases=0)) %>% 
  group_by(postcode) %>% 
  mutate(Accumulated_cases = cumsum(Total_cases)) %>% 
  group_by(isoweek) %>% 
  mutate(Accumulated_share = (Accumulated_cases/sum(Accumulated_cases, na.rm=T))) %>% 
  rename(POA_NAME16 = postcode) %>% 
  mutate(POA_NAME16 = fct_reorder(as.factor(POA_NAME16), Total_cases)) %>% 
  mutate(facet_var = paste0("week ", isoweek, 
                            "\nAccumulated: ", 
                            comma(sum(Accumulated_cases)))) %>% 
  ungroup() %>% 
  filter(!is.na(isoweek)) %>% 
  
  plot_map_TL(rmapshaper::ms_simplify(SYD_POA, .01), 
              "POA_NAME16", "Accumulated_share", 
              "Total Covid-19 cases by POA (SYD Metro)", 
              return_obj="map") + 
  facet_wrap(~facet_var)
```

# Distribution of share overtime
## By quarter

```{r, fig.width=8, fig.height=3.3}
confirmed_cases %>% 
  filter(as.character(postcode) %in% SYD_POA$POA_NAME16) %>% 
  mutate(year_quarter = paste(year(notification_date), "Q",
                             quarter(notification_date), sep="-")) %>% 
  count(year_quarter, postcode, name="Total_cases") %>% 
  complete(year_quarter, postcode, fill = list(Total_cases=0)) %>% 
  group_by(postcode) %>% 
  mutate(Accumulated_cases = cumsum(Total_cases)) %>% 
  ungroup() %>% 
  complete(year_quarter, postcode) %>% 
  replace_na(list(Accumulated_cases=0)) %>% 
  group_by(year_quarter) %>% 
  mutate(Accumulated_share = (Accumulated_cases/sum(Accumulated_cases, na.rm=T))) %>% 
  rename(POA_NAME16 = postcode) %>% 
  ungroup() %>% 
  
  ggplot(aes(x=year_quarter, y=Accumulated_cases, 
             fill=Accumulated_cases > 50,
             group=as.factor(POA_NAME16))) + 
  geom_col(col="white", size=.1) + 
  ggf(fc = DC[2:1]) + 
  ggl("top", lt = T)
```


```{r, fig.width=8, fig.height=2.5}
confirmed_cases %>% 
  filter(as.character(postcode) %in% SYD_POA$POA_NAME16) %>% 
  mutate(year_quarter = paste(year(notification_date), "Q",
                             quarter(notification_date), sep="-")) %>% 
  count(year_quarter, postcode, name="Total_cases") %>% 
  group_by(postcode) %>% 
  mutate(Accumulated_cases = cumsum(Total_cases)) %>% 
  ungroup() %>% 
  complete(year_quarter, postcode) %>% 
  replace_na(list(Accumulated_cases=0)) %>% 
  group_by(year_quarter) %>% 
  mutate(Accumulated_share = (Accumulated_cases/sum(Accumulated_cases, na.rm=T))) %>% 
  rename(POA_NAME16 = postcode) %>% 
  
  ggplot(aes(x=Accumulated_share, fill=as.factor(year_quarter))) + 
  # geom_density() + 
  geom_histogram() + 
  facet_wrap(~year_quarter, nrow = 1) + 
  xlim(0,.03) + 
  ylim(0,40) +
  ggl("none")
```

## By week

```{r, fig.width=8, fig.height=3.3}
confirmed_cases %>% 
  filter(as.character(postcode) %in% SYD_POA$POA_NAME16) %>% 
  filter(year(notification_date) == 2020, 
         # month(notification_date) %in% 3:5, 
         isoweek(notification_date) %in% 10:23) %>% 
  filter(as.character(postcode) %in% SYD_POA$POA_NAME16) %>% 
  mutate(isoweek = isoweek(notification_date)) %>% 
  count(isoweek, postcode, name="Total_cases") %>% 
  complete(isoweek, postcode, fill = list(Total_cases=0)) %>% 
  group_by(postcode) %>% 
  mutate(Accumulated_cases = cumsum(Total_cases)) %>% 
  group_by(isoweek) %>% 
  mutate(Accumulated_share = (Accumulated_cases/sum(Accumulated_cases, 
                                                    na.rm=T))) %>%
  mutate(facet_var = paste0("week ", isoweek, 
                            "\nAccumulated: ", 
                            comma(sum(Accumulated_cases)))) %>% 
  rename(POA_NAME16 = postcode) %>% 
  mutate(POA_NAME16 = fct_reorder(as.factor(POA_NAME16), Total_cases)) %>% 
  ungroup() %>% 
  filter(!is.na(isoweek)) %>% 
  
  ggplot(aes(x=isoweek, y=Accumulated_cases, 
             fill=Accumulated_cases > 20,
             group=as.factor(POA_NAME16))) + 
  geom_col(col="white", size=.1) + 
  ggx(round, pbn=12) +
  ggf(fc = DC[2:1]) + 
  ggl("top", lt = T)
```


```{r, fig.width=8, fig.height=5}
confirmed_cases %>% 
  filter(as.character(postcode) %in% SYD_POA$POA_NAME16) %>% 
  filter(year(notification_date) == 2020, 
         # month(notification_date) %in% 3:5, 
         isoweek(notification_date) %in% 10:23) %>% 
  filter(as.character(postcode) %in% SYD_POA$POA_NAME16) %>% 
  mutate(isoweek = isoweek(notification_date)) %>% 
  count(isoweek, postcode, name="Total_cases") %>% 
  complete(isoweek, postcode, fill = list(Total_cases=0)) %>% 
  group_by(postcode) %>% 
  mutate(Accumulated_cases = cumsum(Total_cases)) %>% 
  group_by(isoweek) %>% 
  mutate(Accumulated_share = (Accumulated_cases/sum(Accumulated_cases, 
                                                    na.rm=T))) %>%
  mutate(facet_var = paste0("week ", isoweek, 
                            "\nAccumulated: ", 
                            comma(sum(Accumulated_cases)))) %>% 
  rename(POA_NAME16 = postcode) %>% 
  mutate(POA_NAME16 = fct_reorder(as.factor(POA_NAME16), Total_cases)) %>% 
  ungroup() %>% 
  filter(!is.na(isoweek)) %>% 
  
  ggplot(aes(x=Accumulated_share, fill=as.factor(isoweek))) + 
  # geom_density() + 
  geom_histogram() + 
  facet_wrap(~isoweek, nrow = 3, labeller = "label_both") + 
  xlim(0,.03) + 
  ylim(0,40) +
  ggl("none")
```

# Local POI
## Public transport

```{r, fig.width=9.5, fig.height=7}
confirmed_cases %>% 
    filter(as.character(postcode) %in% SYD_POA$POA_NAME16) %>% 
    count(postcode, name="Total_cases") %>% 
    rename(POA_NAME16 = postcode) %>% 
    mutate(POA_NAME16 = fct_reorder(as.factor(POA_NAME16), Total_cases)) %>% 
    plot_map_TL(SYD_POA, "POA_NAME16", "Total_cases", fill_col = "grey33",
                "Total Covid-19 cases by POA (SYD Metro), with public transport", 
                show_count = T, label_size = 2, return_obj = "map") +
  
  # geom_map(inherit.aes = FALSE, alpha=.85,
  #          aes(map_id = id), map = tidy(SYD_POA), 
  #          col="grey50", size=.3, fill="white") +
  geom_line(data = SYD_trains, 
            aes(x=lon, y=lat, col="Train",
                group = `Railway line(s)`),
            size=.8) +
  geom_line(data = SYD_ferries, 
            aes(x=lon, y=lat, col="Ferry"),
             size=.8) +
  geom_line(data = SYD_lightrails, 
            aes(x=lon, y=lat, col="Lightrail"),
             size=.8) +
  geom_line(data = SYD_metro, 
            aes(x=lon, y=lat, col="Metro"),
             size=.8) +
  ggc(c("deepskyblue", "red", "darkgreen", "orange")) + 
  guides(col=guide_legend(title="Transport_mode")) + 
  expand_limits(x = tidy(SYD_POA)$long, y = tidy(SYD_POA)$lat) +
  coord_cartesian(xlim = c(150.7, 151.48), ylim = c(-34.1, -33.5)) +
  theme_void() +
  theme(legend.position = c(.9,.35))
```


## Hospitals, Schools, Supermarket

```{r, fig.width=9.5, fig.height=8}
bind_rows(
  SYD_shops %>% select(lon, lat) %>% 
    rename(Long = lon, Lat = lat) %>% mutate(obj = "Shopping centres"), 
  SYD_supermarkets %>% select(lon, lat) %>% 
    rename(Long = lon, Lat = lat) %>% mutate(obj = "Supermarkets"), 
  SYD_hospitals %>% select(Longitude, Latitude) %>% 
    rename(Long = Longitude, Lat = Latitude) %>% mutate(obj = "Hospitals"), 
  rbind(SYD_sschools %>% select(Long, Lat),
        SYD_pschools %>% select(Long, Lat)) %>% mutate(obj = "Schools")
) %>% 
  ggplot() +  
  geom_map(data = SYD_POA, inherit.aes = FALSE, alpha=.85,
           aes(map_id = id), map = tidy(SYD_POA), 
           col="grey50", size=.2, fill="white") +
  geom_jitter(aes(x=Long, y=Lat, col=obj), size=.8, alpha=.5) + 
  stat_density2d(aes(x=Long, y=Lat, 
                     fill=..level.., alpha=..level.., col=obj),
                 binwidth = 1.2, geom="polygon", size=.23) + 
  facet_wrap(~obj) +
  expand_limits(x = tidy(SYD_POA)$long, y = tidy(SYD_POA)$lat) +
  xlim(150.7,151.48) + ylim(-34.1,-33.5) +
  scale_fill_gradient(low="white", high=DC[7]) + 
  scale_alpha_continuous(range = c(0,.3)) + 
  ggc(fc = c("darkred", "deepskyblue", "darkblue", "darkgreen")) + 
  theme_void() +
  theme(legend.position = "none", 
        legend.title = element_blank(), 
        strip.text = element_text(size=15))
```

```{r, fig.width=9.5, fig.height=7}
confirmed_cases %>% 
  filter(as.character(postcode) %in% SYD_POA$POA_NAME16) %>% 
  count(postcode, name="Total_cases") %>% 
  rename(POA_NAME16 = postcode) %>% 
  mutate(POA_NAME16 = fct_reorder(as.factor(POA_NAME16), Total_cases)) %>% 
  plot_map_TL(SYD_POA, "POA_NAME16", "Total_cases", fill_col = "grey33",
              "Total Covid-19 cases by POA (SYD Metro), with hospitals, schools & supermarkets", 
              show_count = T, label_size = 2, return_obj = "map") +
  
  # geom_map(data = SYD_POA, inherit.aes = FALSE, alpha=.85,
  #          aes(map_id = id), map = tidy(SYD_POA), 
  #          col="grey50", size=.3, fill="white") +
  geom_jitter(data = bind_rows(
    SYD_shops %>% select(lon, lat) %>% 
      rename(Long = lon, Lat = lat) %>% mutate(obj = "Shopping centres"), 
    SYD_supermarkets %>% select(lon, lat) %>% 
      rename(Long = lon, Lat = lat) %>% mutate(obj = "Supermarkets"), 
    SYD_hospitals %>% select(Longitude, Latitude) %>% 
      rename(Long = Longitude, Lat = Latitude) %>% mutate(obj = "Hospitals"), 
    rbind(SYD_sschools %>% select(Long, Lat),
          SYD_pschools %>% select(Long, Lat)) %>% mutate(obj = "Schools")
  ), 
  size = 1, alpha = .3, aes(x=Long, y=Lat,col=obj)) +
  expand_limits(x = tidy(SYD_POA)$long, y = tidy(SYD_POA)$lat) +
  xlim(150.7,151.48) + ylim(-34.1,-33.5) +
  # scale_fill_gradient(low="white", high=DC[7]) + 
  scale_alpha_continuous(range = c(0,.3)) + 
  ggc(fc = c("darkred", "darkblue", "darkorange", "darkgreen")) + 
  guides(color = guide_legend(override.aes = list(size=3), 
                              title="POI")) + 
  theme_void() +
  theme(legend.position = c(.9,.25), 
        # legend.title = element_blank(), 
        strip.text = element_text(size=15))
```
## POI combined

```{r, fig.width=9.5, fig.height=7}
confirmed_cases %>% 
  filter(as.character(postcode) %in% SYD_POA$POA_NAME16) %>% 
  count(postcode, name="Total_cases") %>% 
  rename(POA_NAME16 = postcode) %>% 
  mutate(POA_NAME16 = fct_reorder(as.factor(POA_NAME16), Total_cases)) %>% 
  plot_map_TL(SYD_POA, "POA_NAME16", "Total_cases", fill_col = "grey33",
              "Total Covid-19 cases by POA (SYD Metro), with hospitals, schools & supermarkets", 
              show_count = T, label_size = 2, return_obj = "map") +
  geom_line(data = SYD_trains, 
            aes(x=lon, y=lat, col="Train",
                group = `Railway line(s)`),
            size=.8) +
  geom_line(data = SYD_ferries, 
            aes(x=lon, y=lat, col="Ferry"),
             size=.8) +
  geom_line(data = SYD_lightrails, 
            aes(x=lon, y=lat, col="Lightrail"),
             size=.8) +
  geom_line(data = SYD_metro, 
            aes(x=lon, y=lat, col="Metro"),
             size=.8) +
  
  # geom_map(data = SYD_POA, inherit.aes = FALSE, alpha=.85,
  #          aes(map_id = id), map = tidy(SYD_POA), 
  #          col="grey50", size=.3, fill="white") +
  geom_jitter(data = bind_rows(
    SYD_shops %>% select(lon, lat) %>% 
      rename(Long = lon, Lat = lat) %>% mutate(obj = "Shopping centres"), 
    SYD_supermarkets %>% select(lon, lat) %>% 
      rename(Long = lon, Lat = lat) %>% mutate(obj = "Supermarkets"), 
    SYD_hospitals %>% select(Longitude, Latitude) %>% 
      rename(Long = Longitude, Lat = Latitude) %>% mutate(obj = "Hospitals"), 
    rbind(SYD_sschools %>% select(Long, Lat),
          SYD_pschools %>% select(Long, Lat)) %>% mutate(obj = "Schools")
  ), 
  size = 1, alpha = .3, aes(x=Long, y=Lat,col=obj)) +
  expand_limits(x = tidy(SYD_POA)$long, y = tidy(SYD_POA)$lat) +
  xlim(150.7,151.48) + ylim(-34.1,-33.5) +
  # scale_fill_gradient(low="white", high=DC[7]) + 
  scale_alpha_continuous(range = c(0,.3)) + 
  ggc(fc = c("deepskyblue", "darkblue", "red", "darkgreen", 
             "darkblue", "red", "darkgreen", "orange")) + 
  guides(color = guide_legend(override.aes = list(size=3), 
                              title="POI")) + 
  theme_void() +
  theme(legend.position = c(.9,.4), 
        # legend.title = element_blank(), 
        strip.text = element_text(size=15))
```

## POI count QA {.tabset}
### Hospital

```{r, fig.width=9.5, fig.height=7}
n_poi_by_POA %>% 
  filter(POA_NAME16 != "Unknown") %>% 
  # gather(key, value, -POA_NAME16) %>% 
  select(POA_NAME16, n_hospitals) %>% 
  mutate(POA_NAME16 = fct_reorder(POA_NAME16, n_hospitals)) %>% 
  plot_map_TL(SYD_POA, "POA_NAME16", "n_hospitals", 
              "Number of hospitals by POA", 
              show_count = T, fill_col = "darkred")
```

### Schools

```{r, fig.width=9.5, fig.height=7}
n_poi_by_POA %>% 
  filter(POA_NAME16 != "Unknown") %>% 
  # gather(key, value, -POA_NAME16) %>% 
  select(POA_NAME16, n_schools) %>% 
  mutate(POA_NAME16 = fct_reorder(POA_NAME16, n_schools)) %>% 
  plot_map_TL(SYD_POA, "POA_NAME16", "n_schools", 
              "Number of schools by POA", 
              show_count = T, fill_col = "deepskyblue")
```


### Supermarkets

```{r, fig.width=9.5, fig.height=7}
n_poi_by_POA %>% 
  filter(POA_NAME16 != "Unknown") %>% 
  # gather(key, value, -POA_NAME16) %>% 
  select(POA_NAME16, n_supermarkets) %>% 
  mutate(POA_NAME16 = fct_reorder(POA_NAME16, n_supermarkets)) %>% 
  plot_map_TL(SYD_POA, "POA_NAME16", "n_supermarkets", 
              "Number of supermarkets by POA", 
              show_count = T, fill_col = "darkgreen")
```


### Shopping centres

```{r, fig.width=9.5, fig.height=7}
n_poi_by_POA %>% 
  filter(POA_NAME16 != "Unknown") %>% 
  # gather(key, value, -POA_NAME16) %>% 
  select(POA_NAME16, n_shoppingCentres) %>% 
  mutate(POA_NAME16 = fct_reorder(POA_NAME16, n_shoppingCentres)) %>% 
  plot_map_TL(SYD_POA, "POA_NAME16", "n_shoppingCentres", 
              "Number of shopping centres by POA", 
              show_count = T, fill_col = "black")
```

### Public transports

```{r, fig.width=9.5, fig.height=7}
n_poi_by_POA %>% 
  filter(POA_NAME16 != "Unknown") %>% 
  # gather(key, value, -POA_NAME16) %>% 
  select(POA_NAME16, n_publicTransports ) %>% 
  mutate(POA_NAME16 = fct_reorder(POA_NAME16, n_publicTransports )) %>% 
  plot_map_TL(SYD_POA, "POA_NAME16", "n_publicTransports", 
              "Number of public transports by POA", 
              show_count = T, fill_col = "darkorange")
```

# Gravity
## South Eastern SYD (2026) {.tabset}
### Radial distance

```{r, fig.width=9.5, fig.height=7}
(
plot_gravity_map_TL(n_poi_by_POA, "2026", "n_hospitals") + 
  xlim(151.1,151.33) + ylim(-34,-33.7) | 
plot_gravity_map_TL(n_poi_by_POA, "2026", "n_schools") + 
  xlim(151.1,151.33) + ylim(-34,-33.7) |
plot_gravity_map_TL(n_poi_by_POA, "2026", "n_supermarkets") + 
  xlim(151.1,151.33) + ylim(-34,-33.7)
) /
(
plot_gravity_map_TL(n_poi_by_POA, "2026", "n_shoppingCentres") + 
  xlim(151.1,151.33) + ylim(-34,-33.7) | 
plot_gravity_map_TL(n_poi_by_POA, "2026", "n_publicTransports") + 
  xlim(151.1,151.33) + ylim(-34,-33.7) | 
n_poi_by_POA %>% 
  mutate(combined_index = 
           normalised_n_hospitals +
           normalised_n_schools +
           normalised_n_supermarkets +
           normalised_n_shoppingCentres +
           normalised_n_publicTransports
  ) %>% plot_gravity_map_TL("2026", "combined_index") + 
  xlim(151.1,151.33) + ylim(-34,-33.7)
)
```
### Travel time distance

```{r, fig.width=9.5, fig.height=7}
(
plot_gravity_map_TL(n_poi_by_POA, "2026", "n_hospitals", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000)) + 
  xlim(151.1,151.33) + ylim(-34,-33.7) | 
plot_gravity_map_TL(n_poi_by_POA, "2026", "n_schools", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000)) + 
  xlim(151.1,151.33) + ylim(-34,-33.7) |
plot_gravity_map_TL(n_poi_by_POA, "2026", "n_supermarkets", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000)) + 
  xlim(151.1,151.33) + ylim(-34,-33.7)
) /
(
plot_gravity_map_TL(n_poi_by_POA, "2026", "n_shoppingCentres", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000)) + 
  xlim(151.1,151.33) + ylim(-34,-33.7) | 
plot_gravity_map_TL(n_poi_by_POA, "2026", "n_publicTransports", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000)) + 
  xlim(151.1,151.33) + ylim(-34,-33.7) | 
n_poi_by_POA %>% 
  mutate(combined_index = 
           normalised_n_hospitals +
           normalised_n_schools +
           normalised_n_supermarkets +
           normalised_n_shoppingCentres +
           normalised_n_publicTransports
  ) %>% plot_gravity_map_TL("2026", "combined_index", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000)) + 
  xlim(151.1,151.33) + ylim(-34,-33.7)
)
```

## Western SYD (2145) {.tabset}
### Radial distance

```{r, fig.width=9.5, fig.height=7}
(
plot_gravity_map_TL(n_poi_by_POA, "2145", "n_hospitals") | 
plot_gravity_map_TL(n_poi_by_POA, "2145", "n_schools") |
plot_gravity_map_TL(n_poi_by_POA, "2145", "n_supermarkets")
) /
(
plot_gravity_map_TL(n_poi_by_POA, "2145", "n_shoppingCentres") | 
plot_gravity_map_TL(n_poi_by_POA, "2145", "n_publicTransports") | 
n_poi_by_POA %>% 
  mutate(combined_index = 
           normalised_n_hospitals +
           normalised_n_schools +
           normalised_n_supermarkets +
           normalised_n_shoppingCentres +
           normalised_n_publicTransports
  ) %>% plot_gravity_map_TL("2145", "combined_index")
)
```
### Travel time distance

```{r, fig.width=9.5, fig.height=7}
(
plot_gravity_map_TL(n_poi_by_POA, "2145", "n_hospitals", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000)) | 
plot_gravity_map_TL(n_poi_by_POA, "2145", "n_schools", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000)) |
plot_gravity_map_TL(n_poi_by_POA, "2145", "n_supermarkets", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000))
) /
(
plot_gravity_map_TL(n_poi_by_POA, "2145", "n_shoppingCentres", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000)) | 
plot_gravity_map_TL(n_poi_by_POA, "2145", "n_publicTransports", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000)) | 
n_poi_by_POA %>% 
  mutate(combined_index = 
           normalised_n_hospitals +
           normalised_n_schools +
           normalised_n_supermarkets +
           normalised_n_shoppingCentres +
           normalised_n_publicTransports
  ) %>% plot_gravity_map_TL("2145", "combined_index", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000))
)
```

## Nothern SYD (2107) {.tabset}
### Radial distance

```{r, fig.width=9.5, fig.height=7}
(
plot_gravity_map_TL(n_poi_by_POA, "2107", "n_hospitals") + 
  xlim(151,151.4) + ylim(-33.9,-33.5) | 
plot_gravity_map_TL(n_poi_by_POA, "2107", "n_schools") + 
  xlim(151,151.4) + ylim(-33.9,-33.5) |
plot_gravity_map_TL(n_poi_by_POA, "2107", "n_supermarkets") + 
  xlim(151,151.4) + ylim(-33.9,-33.5)
) /
(
plot_gravity_map_TL(n_poi_by_POA, "2107", "n_shoppingCentres") + 
  xlim(151,151.4) + ylim(-33.9,-33.5) | 
plot_gravity_map_TL(n_poi_by_POA, "2107", "n_publicTransports") + 
  xlim(151,151.4) + ylim(-33.9,-33.5) | 
n_poi_by_POA %>% 
  mutate(combined_index = 
           normalised_n_hospitals +
           normalised_n_schools +
           normalised_n_supermarkets +
           normalised_n_shoppingCentres +
           normalised_n_publicTransports
  ) %>% plot_gravity_map_TL("2107", "combined_index") + 
  xlim(151,151.4) + ylim(-33.9,-33.5)
)
```
### Travel time distance

```{r, fig.width=9.5, fig.height=7}
(
plot_gravity_map_TL(n_poi_by_POA, "2107", "n_hospitals", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000)) + 
  xlim(151,151.4) + ylim(-33.9,-33.5) | 
plot_gravity_map_TL(n_poi_by_POA, "2107", "n_schools", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000)) + 
  xlim(151,151.4) + ylim(-33.9,-33.5) |
plot_gravity_map_TL(n_poi_by_POA, "2107", "n_supermarkets", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000)) + 
  xlim(151,151.4) + ylim(-33.9,-33.5)
) /
(
plot_gravity_map_TL(n_poi_by_POA, "2107", "n_shoppingCentres", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000)) + 
  xlim(151,151.4) + ylim(-33.9,-33.5) | 
plot_gravity_map_TL(n_poi_by_POA, "2107", "n_publicTransports", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000)) + 
  xlim(151,151.4) + ylim(-33.9,-33.5) | 
n_poi_by_POA %>% 
  mutate(combined_index = 
           normalised_n_hospitals +
           normalised_n_schools +
           normalised_n_supermarkets +
           normalised_n_shoppingCentres +
           normalised_n_publicTransports
  ) %>% plot_gravity_map_TL("2107", "combined_index", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000)) + 
  xlim(151,151.4) + ylim(-33.9,-33.5)
)
```

# Suggested "high-risk" area
## South Eastern SYD (2026)

```{r}
bind_rows(
calc_gravity_TL(n_poi_by_POA, "2026", "n_hospitals", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000))
,calc_gravity_TL(n_poi_by_POA, "2026", "n_schools", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000))
,calc_gravity_TL(n_poi_by_POA, "2026", "n_supermarkets", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000))
,calc_gravity_TL(n_poi_by_POA, "2026", "n_shoppingCentres", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000))
,calc_gravity_TL(n_poi_by_POA, "2026", "n_publicTransports", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000))
) %>% 
  group_by(target, source) %>% 
  summarise(risk_factor = sum(gravity_rank)) %>% 
  # slice_max(risk_factor, n=11) %>% 
  # pdf()
  
  left_join(
    confirmed_cases %>% 
      filter(notification_date < ymd(20200701)) %>% 
      count(postcode, name = "total_cases") %>% 
      mutate(source = as.character(postcode)), 
    by="source"
  ) %>% 
  mutate(text_lab = ifelse(total_cases >= 30, source, NA)) %>% 
  ggplot(aes(x=risk_factor, y=total_cases)) + 
  geom_point() + 
  stat_smooth() + 
  geom_text_repel(aes(label=text_lab)) + 
  labs(subtitle = "Based on total cases before date 2020-07-01") + 
  ggl(base_size=12)
```
## Western SYD (2145)

```{r}
bind_rows(
calc_gravity_TL(n_poi_by_POA, "2145", "n_hospitals", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000))
,calc_gravity_TL(n_poi_by_POA, "2145", "n_schools", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000))
,calc_gravity_TL(n_poi_by_POA, "2145", "n_supermarkets", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000))
,calc_gravity_TL(n_poi_by_POA, "2145", "n_shoppingCentres", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000))
,calc_gravity_TL(n_poi_by_POA, "2145", "n_publicTransports", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000))
) %>% 
  group_by(target, source) %>% 
  summarise(risk_factor = sum(gravity_rank)) %>% 
  # slice_max(risk_factor, n=11) %>%
  # pdf()
  left_join(
    confirmed_cases %>% 
      filter(notification_date >= ymd(20200701), 
             notification_date < ymd(20201101)) %>% 
      count(postcode, name = "total_cases") %>% 
      mutate(source = as.character(postcode)), 
    by="source"
  ) %>% 
  mutate(text_lab = ifelse(total_cases >= 15, source, NA)) %>% 
  ggplot(aes(x=risk_factor, y=total_cases)) + 
  geom_point() + 
  stat_smooth() + 
  geom_text_repel(aes(label=text_lab)) + 
  labs(subtitle = "Based on total cases between date 2020-07-01 and 2020-12-01") + 
  ggl(base_size=12)
```

## Nothern SYD (2107)

```{r}
bind_rows(
calc_gravity_TL(n_poi_by_POA, "2107", "n_hospitals", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000))
,calc_gravity_TL(n_poi_by_POA, "2107", "n_schools", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000))
,calc_gravity_TL(n_poi_by_POA, "2107", "n_supermarkets", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000))
,calc_gravity_TL(n_poi_by_POA, "2107", "n_shoppingCentres", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000))
,calc_gravity_TL(n_poi_by_POA, "2107", "n_publicTransports", 
                    dist_matrix = SYD_POA_mapdist %>% mutate(dist = dist/1000))
) %>% 
  group_by(target, source) %>% 
  summarise(risk_factor = sum(gravity_rank)) %>% 
  # slice_max(risk_factor, n=11) %>% 
  # pdf()
  left_join(
    confirmed_cases %>% 
      filter(notification_date >= ymd(20201101)) %>% 
      count(postcode, name = "total_cases") %>% 
      mutate(source = as.character(postcode)), 
    by="source"
  ) %>% 
  mutate(text_lab = ifelse(total_cases >= 15, source, NA)) %>% 
  ggplot(aes(x=risk_factor, y=total_cases)) + 
  geom_point() + 
  stat_smooth() + 
  geom_text_repel(aes(label=text_lab)) +
  labs(subtitle = "Based on total cases after date 2020-12-01") + 
  ggl(base_size=12)
```

# Gravity parameters

```{r}
SYD_POA_mapdist %>% 
  filter(target == "2145") %>% 
  left_join(n_poi_by_POA, by=c("source"="POA_NAME16")) %>% 
  left_join(n_poi_by_POA %>% filter(POA_NAME16 == "2145"), 
            suffix = c("","_target"), 
            by=c("target"="POA_NAME16")) %>% 
  left_join(confirmed_cases %>% 
              filter(notification_date >= ymd(20200701), 
                     notification_date < ymd(20201101)) %>% 
              count(postcode, name="Total_cases") %>% 
              mutate(source = as.character(postcode)), by="source") %>% 
  mutate(total_normalised_mass_source = 
           normalised_n_hospitals + 
           normalised_n_schools + 
           normalised_n_supermarkets + 
           normalised_n_shoppingCentres + 
           normalised_n_publicTransports) %>% 

  lm(log(Total_cases + 0.01) ~ 
       # log(total_normalised_mass_source + 0.01) + 
       log(n_hospitals + 0.01) +
       log(n_schools + 0.01) +
       log(n_supermarkets + 0.01) +
       log(n_shoppingCentres + 0.01) +
       log(n_publicTransports + 0.01) +
       log(n_hospitals + 0.01) +
       log(dist + 0.01), data=.) %>% 
  summary()
```























